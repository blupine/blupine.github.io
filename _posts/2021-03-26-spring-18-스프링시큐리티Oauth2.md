---
layout: post
title:  "[스프링 시큐리티] OAuth2.0 로그인 구현 및 분석"
subtitle: ""
date:   2021-03-26 22:11:21 +0900
categories: dev
tags : Spring
---

<!-- ### [구현커밋]({{"https://github.com/blupine/godingeta/commit/b6b190632fb07b59a6048b80c0c57d3e7a1e6d31"}}) -->

이전 포스팅에서는 국내의 대표적인 OAuth2 Provider인 네이버, 카카오의 API 사용을 위한 `Authorization Code`, `Access Token`의 발급 방법과, 이를 사용하는 방법에 대해 다뤘음

`Access Token`을 이용해서 직접 네이버, 카카오의 API를 호출하고, 사용자 정보를 가져와도 되지만 스프링 시큐리티에서 제공하는 기능을 이용하면 사용자 정보를 가져오고, 인증하는 절차를 직접 구현하지 않아도 된다.

-----------------------------------------------------

먼저 스프링 시큐리티에서는 기본적으로 몇 개의 OAuth Provider에 대해서 구현이 되어있다. `GOOGLE`, `FACEBOOK`, `GITHUB`, `OKTA`에 대해서 구현되어 있어서, 해당 OAuth Provider를 사용하기 위해서는 API Key만 properties 파일에 정의해두면 가능한 것으로 보인다.

그러나 네이버, 카카오와 같이 국내 서비스들에서 많이 이용되는 소셜로그인을 구현하기 위해서는 OAuthProvider를 커스텀해서 정의해주어야 한다.
스프링시큐리티의 OAuth 인증 절차를 이해해보기 위해 해당 포스팅을 작성하며 우선 카카오를 기준으로 구현을 해본다.

### 1. ClientRegistration 정의
- 각 OAuth2 Provider를 식별할 수 있는 `registrationId` : 이게 식별자 역할을 함(아래 예제에선 "kakao"로 등록함)
- 각 OAuth2 Provider에서 제공하는 인가 코드 요청 URI(`authorizationUri`)
- 각 OAuth2 Provider에서 제공하는 access token 요청 URI(`tokenUri`)
- 각 OAuth2 Provider에서 제공하는 사용자 정보 요청 URI(`userInfoUri`)
- 각 OAuth2 Provider에서 애플리케이션 등록 후 발급받은 `clientId`, `clientSecret`
- `DEFAULT_LOGIN_REDIRECT_URL`은 아래 정의된 대로 정의(스프링 시큐리티에서 해당 URI에 대한 요청을 Filter에서 가로채고 OAuth2 인증 기능을 제공함 - 아래 자세한 설명 참고)

```java
public enum CustomOAuthProvider {

    KAKAO {

        @Override
        public ClientRegistration.Builder getBuilder() {
            return getBuilder("kakao", ClientAuthenticationMethod.POST)  // registrationId : "kakao"
                    .scope("profile")
                    .authorizationUri("https://kauth.kakao.com/oauth/authorize")
                    .tokenUri("https://kauth.kakao.com/oauth/token")
                    .userInfoUri("https://kapi.kakao.com/v2/user/me")
                    .clientId("df558539d52941403071fa6b9c3e1c60")
                    .clientSecret("Xva57W8O3zObZy4IPoP004aamYV7WgXG")
                    .userNameAttributeName("id")
                    .clientName("Kakao");
        }

    };

    private static final String DEFAULT_LOGIN_REDIRECT_URL = "{baseUrl}/login/oauth2/code/{registrationId}";

    protected final ClientRegistration.Builder getBuilder(String registrationId,
                                                          ClientAuthenticationMethod method) {
        ClientRegistration.Builder builder = ClientRegistration.withRegistrationId(registrationId);
        builder.clientAuthenticationMethod(method);
        builder.authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE);
        builder.redirectUri(CustomOAuthProvider.DEFAULT_LOGIN_REDIRECT_URL);
        return builder;
    }

    public abstract ClientRegistration.Builder getBuilder();
}
```

### 2. ClientRegistration 등록
- `ClientRegistrationRepository`에 위에서 정의한 `ClientRegistration`을 저장해줌
- 이후 스프링 시큐리티가 ClientRespository에서 registrationId를 기준으로 ClientRegistration을 가져오고, 여기서 등록했던 정보(`authroizationUri`, `tokenUri`, `userInfoUri`)를 바탕으로 인증하고 유저 데이터를 가져온다.

```java
@Configuration
public class OAuthConfiguration {
    @Bean
    public ClientRegistrationRepository clientRegistrationRepository() {
        final ClientRegistration clientRegistration = CustomOAuthProvider.KAKAO
                .getBuilder()
                .build();

        return new InMemoryClientRegistrationRepository(Collections.singletonList(
                clientRegistration
        ));
    }
}
```

### 3. API 인증 Callback redirect URI 등록
- Kakao developer 페이지에서 아래 경로로 rediret uri를 등록한다
- ![1]({{"assets/img/dev/spring/18/1.png" | absolute_url}})

